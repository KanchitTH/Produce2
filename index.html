<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ProductionFlow</title>

    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡πÇ‡∏¢‡∏á‡∏Å‡∏±‡∏ö manifest.json -->
    <link rel="manifest" href="/manifest.json">

    <!-- ‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡∏ü‡∏≠‡∏ô‡∏ï‡πå‡∏à‡∏≤‡∏Å Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Kanit&display=swap" rel="stylesheet">

    <style>
      #userEmail {
        color: #555;
      }
      * {
        font-family: 'Kanit', sans-serif;
      }
      body {
        margin: 0;
        background: #f2f9f1;
        padding: 20px;
      }
      .container {
        max-width: 1000px;
        margin: auto;
        background: #fff;
        padding: 20px;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h2, h3 {
        color: #34a853;
      }
      select, input, button {
        font-family: 'Kanit', sans-serif;
        padding: 8px;
        margin: 5px 0;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
      }
      th, td {
        padding: 8px;
        border: 1px solid #ccc;
        text-align: left;
      }
      #bomTable th {
        background-color: #e0f7e9;
      }
      #stockTable th {
        background-color: #f0f0f0;
      }
      .spinner {
        display: none;
        margin: 10px auto;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #34a853;
        border-radius: 50%;
        width: 36px;
        height: 36px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>

    <!-- ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('/service-worker.js').then(function(registration) {
          console.log('Service Worker registered with scope:', registration.scope);
        }).catch(function(error) {
          console.log('Service Worker registration failed:', error);
        });
      }
    </script>
  </head>

  <body>
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
        <h2 style="margin: 0;">‡∏£‡∏∞‡∏ö‡∏ö ProductionFlow</h2>
        <div style="font-weight: bold;">üë§ ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: <span id="userEmail">Loading...</span></div>
      </div>

      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ú‡∏•‡∏¥‡∏ï:</label>
      <select id="productSelect" onchange="onProductSelect()"></select>

      <br>
      <label>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ú‡∏•‡∏¥‡∏ï (kg):</label>
      <input type="number" id="qtyInput" value="1" min="0" step="1" oninput="updateBOMQty()">

      <table id="bomTable"></table>

      <br>
      <button id="saveBtn" onclick="saveRequest()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å</button>
      <button onclick="clearForm()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>

      <div id="saveSpinner" class="spinner"></div>

      <br><br>
      <label>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å:</label>
      <select id="requestIdSelect">
        <option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å --</option>
      </select>
      <button onclick="exportPDF()">üìÑ ‡πÇ‡∏´‡∏•‡∏î‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡πÄ‡∏õ‡πá‡∏ô PDF</button>
      <div id="spinner" class="spinner"></div>

      <hr>
      <h3>üîç ‡πÄ‡∏ä‡πá‡∏Ñ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏Ñ‡∏•‡∏±‡∏á</h3>
      <input type="text" id="searchInput" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤..." oninput="filterStock()">
      <table id="stockTable">
        <thead>
          <tr><th>‡∏£‡∏´‡∏±‡∏™‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤</th><th>‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <!-- ‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Apps Script -->
    <script>
      let currentBOM = [];
      let currentUserEmail = "";

      function fetchInitial() {
        // ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Apps Script Web App
        fetch("https://script.googleusercontent.com/macros/echo?user_content_key=AehSKLgXD7dSwONR1JRqdDkHqELjqmbL01TPPwMnVt854Md2vbkT0SXR97YTd8Bzobse_wnuGDvwkBghmCLOc9Q9ass6DGdwA91gORfI4yexL5RKRxrHmY3EAmFGyXvoJMQA_rzV_W1AsaJ0C8-NlELKfgEJnds_psuypXNc-9DiYBVjLfVzN9TthPGJ-MJqtpDoarnmDQbi4zl6I7ESS9SlfmysyIA9AO-D1wTqJLVaU2YggAKQPl98Aa21oOxnWPgCiWa1BpeRZQkIlZTtQbk2v7GHbVCTDi2uaSdcsHAt&lib=Ms312KQZrTfKGLXK0hJbQf5PAOmt3wVip")
          .then(response => response.json())
          .then(data => {
            console.log(data);  // ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏Å Google Apps Script
            document.getElementById('responseContainer').innerText = `Message: ${data.message}, Time: ${data.time}`;
          })
          .catch(error => console.error('Error:', error));
      }

      window.onload = () => {
        fetchInitial();
        google.script.run.withSuccessHandler(renderRequestDropdown).getRequestIds();
      };

      function renderProductDropdown(products) {
        const select = document.getElementById("productSelect");
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ --</option>';
        products.forEach(name => {
          const option = document.createElement("option");
          option.value = name;
          option.textContent = name;
          select.appendChild(option);
        });
      }

      function onProductSelect() {
        const product = document.getElementById("productSelect").value;
        if (!product) return;
        google.script.run.withSuccessHandler(renderBOM).getBOM(product);
      }

      function renderBOM(data) {
        currentBOM = data;
        updateBOMQty();
      }

      function updateBOMQty() {
        const qty = parseFloat(document.getElementById("qtyInput").value) || 1;
        const table = document.getElementById("bomTable");
        table.innerHTML = "<tr><th>‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏î‡∏¥‡∏ö</th><th>RM</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÑ‡∏î‡πâ)</th></tr>";

        currentBOM.forEach((row, i) => {
          const baseQty = parseFloat(row[2]) || 0;
          const calcQty = (baseQty * qty).toFixed(3);
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${row[0]}</td>
            <td>${row[1]}</td>
            <td><input type="number" value="${calcQty}" min="0" step="0.001" data-index="${i}" onchange="onQtyChange(event)"></td>
          `;
          table.appendChild(tr);
        });
      }

      function onQtyChange(e) {
        const index = e.target.dataset.index;
        currentBOM[index][2] = parseFloat(e.target.value);
      }

      function saveRequest() {
        const productName = document.getElementById("productSelect").value;
        const qty = parseFloat(document.getElementById("qtyInput").value);
        if (!productName || !qty || qty <= 0) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏Å‡∏£‡∏≠‡∏Å‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏•‡∏¥‡∏ï‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
          return;
        }

        document.getElementById("saveSpinner").style.display = "block";
        document.getElementById("saveBtn").disabled = true;

        const items = [];
        const rows = document.querySelectorAll("#bomTable tr");
        rows.forEach((row, index) => {
          if (index === 0) return;
          const cells = row.querySelectorAll("td");
          if (cells.length >= 3) {
            const rm = cells[1].innerText.trim();
            const qty = parseFloat(cells[2].querySelector("input").value);
            if (rm && !isNaN(qty)) {
              items.push({ name: rm, qty });
            }
          }
        });

        const payload = {
          date: new Date().toISOString().split("T")[0],
          productName,
          qty,
          items,
          requesterEmail: currentUserEmail
        };

        google.script.run
          .withSuccessHandler(requestId => {
            alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏•‡∏Ç‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å: " + requestId);
            document.getElementById("saveSpinner").style.display = "none";
            document.getElementById("saveBtn").disabled = false;
            google.script.run.withSuccessHandler(renderRequestDropdown).getRequestIds();
          })
          .withFailureHandler(err => {
            alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + err.message);
            document.getElementById("saveSpinner").style.display = "none";
            document.getElementById("saveBtn").disabled = false;
          })
          .saveRequest(payload);
      }

      function renderRequestDropdown(ids) {
        const select = document.getElementById("requestIdSelect");
        select.innerHTML = '<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å --</option>';
        ids.forEach(id => {
          const option = document.createElement("option");
          option.value = id;
          option.textContent = id;
          select.appendChild(option);
        });
      }

      function exportPDF() {
        const id = document.getElementById("requestIdSelect").value;
        if (!id) {
          alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÉ‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å‡∏Å‡πà‡∏≠‡∏ô‡πÇ‡∏´‡∏•‡∏î PDF");
          return;
        }

        const spinner = document.getElementById("spinner");
        spinner.style.display = "block";

        google.script.run
          .withSuccessHandler(data => {
            spinner.style.display = "none";
            if (!data || data.length < 50) {
              alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á PDF ‡πÑ‡∏î‡πâ");
              return;
            }
            const link = document.createElement('a');
            link.href = "data:application/pdf;base64," + data;
            link.download = `ProductionRequest_${id}.pdf`;
            link.click();
          })
          .withFailureHandler(err => {
            spinner.style.display = "none";
            alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î PDF ‡πÑ‡∏î‡πâ: " + err.message);
          })
          .generatePDF(id);
      }

      function renderStockTable(data) {
        const tbody = document.querySelector("#stockTable tbody");
        tbody.innerHTML = "";
        data.slice(1).forEach(row => {
          const tr = document.createElement("tr");
          tr.innerHTML = `<td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>`;
          tbody.appendChild(tr);
        });
      }

      function filterStock() {
        const input = document.getElementById("searchInput").value.toLowerCase();
        const rows = document.querySelectorAll("#stockTable tbody tr");
        rows.forEach(row => {
          row.style.display = row.innerText.toLowerCase().includes(input) ? "" : "none";
        });
      }

      function clearForm() {
        document.getElementById("productSelect").value = "";
        document.getElementById("qtyInput").value = 1;
        document.getElementById("bomTable").innerHTML = "";
        document.getElementById("requestIdSelect").value = "";
      }
    </script>
  </body>
</html>
